{
    "AWSTemplateFormatVersion": "2010-09-09",
    "Description":"This template onboards your AWS account to interact with the Amazon Selling Partner API. An example lambda function is included. (qs-1s617385e)",
    "Parameters":{
      "QSS3BucketName":{
          "Type":"String",

            "Default":"aws-quickstart"
      },
      "QSS3KeyPrefix":{
        "AllowedPattern": "^[0-9a-zA-Z-/]*$",
        "Default": "quickstart-amazon-selling-partner-api/",
        "Type":"String"
      }
    },
    "Resources": {
        "SPAPIIAMRole": {
            "Type" : "AWS::IAM::Role",
            "Properties" : {
                "AssumeRolePolicyDocument" : {
                    "Version": "2012-10-17",
                    "Statement": [{
                            "Effect": "Allow",
                            "Principal": {
                                "AWS": {
                                    "Fn::Join":[
                                        ":",
                                        [
                                            "arn:aws:iam:",
                                            {
                                                "Ref":"AWS::AccountId"
                                            },
                                            "root"
                                        ]
                                    ]
                                }
                            },
                            "Action": "sts:AssumeRole",
                            "Condition": {}
                        }]
                },
                "Policies" : [ {
                "PolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [{
                        "Effect": "Allow",
                        "Action": "execute-api:Invoke",
                        "Resource": "arn:aws:execute-api:*:*:*"
                    }]
                },
                "PolicyName": "SellingPartnerAPI"
            }],
                "RoleName" : "SPAPIIAMRole"
            }
        },
        "LambdaExecutionRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "RoleName": "SPAPILambdaRole",
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [{
                        "Effect": "Allow",
                        "Principal": {
                            "Service": "lambda.amazonaws.com"
                        },
                        "Action": "sts:AssumeRole"
                    }]
                },
                "Policies": [{
                    "PolicyName": "SPDSLambdaPolicy",
                    "PolicyDocument": {
                        "Version": "2012-10-17",
                        "Statement": [{
                            "Sid": "VisualEditor0",
                            "Effect": "Allow",
                            "Action": ["sts:AssumeRole","logs:CreateLogGroup","logs:CreateLogStream","logs:PutLogEvents"],
                            "Resource": "*"
                        }]
                    }
                }
            ]
            }
        },
        "LambdaFunction": {
            "Type": "AWS::Lambda::Function",
            "Properties": {
                "Handler": "lambda_function.lambda_handler",
                "Role": {
                    "Fn::GetAtt": ["LambdaExecutionRole", "Arn"]
                },
                "Code": {
                    "S3Bucket": {"Ref":"QSS3BucketName"},
                    "S3Key": {"Fn::Sub":"${QSS3KeyPrefix}functions/packages/ExampleLambda/lambda.zip"
                }},
                "Runtime": "python3.8"
            }
        }
}
}
